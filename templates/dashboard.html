<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXä»®æƒ³å–å¼•ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h3 {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .card .value {
            font-size: 2rem;
            font-weight: 700;
        }
        .card .sub { color: #888; font-size: 0.9rem; margin-top: 4px; }
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .neutral { color: #ffa502; }

        .section-title {
            font-size: 1.2rem;
            margin: 30px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chart-container {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-card h3 {
            color: #00d4ff;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        th {
            background: rgba(255,255,255,0.05);
            color: #888;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        tr:hover { background: rgba(255,255,255,0.03); }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge.buy { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge.sell { background: rgba(255,71,87,0.2); color: #ff4757; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }
        .stat-item .label { color: #888; font-size: 0.8rem; }
        .stat-item .val { font-size: 1.3rem; font-weight: 600; margin-top: 5px; }

        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.85rem;
            margin-top: 30px;
        }

        .strategy-badge {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(0,212,255,0.1);
            border-radius: 30px;
            display: inline-block;
            font-size: 0.9rem;
            color: #00d4ff;
        }
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-bottom: 30px;
        }

        /* è²¡å¸ƒã‚µãƒãƒªãƒ¼ */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .wallet-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .wallet-card.swing { border-left: 4px solid #00ff88; }
        .wallet-card.day { border-left: 4px solid #ffa502; }
        .wallet-card h3 { font-size: 1.1rem; margin-bottom: 12px; }
        .wallet-card .wallet-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .wallet-card .wallet-row:last-child { border-bottom: none; }
        .wallet-card .wallet-label { color: #888; font-size: 0.85rem; }
        .wallet-card .wallet-value { font-weight: 600; }
        .strategy-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .strategy-tag.wait { background: rgba(0,255,136,0.2); color: #00ff88; }
        .strategy-tag.day { background: rgba(255,165,2,0.2); color: #ffa502; }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .card .value { font-size: 1.5rem; }
            th, td { padding: 10px 8px; font-size: 0.85rem; }
            .chart-grid { grid-template-columns: 1fr; }
            .wallet-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>ğŸ„ é‡‘åˆ©ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»ã‚µãƒ¼ãƒ•ã‚£ãƒ³</h1>
            <div class="strategy-badge">Interest Rate Trend Surfing | Ver 1.3.0</div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>æ®‹é«˜</h3>
                <div class="value" id="balance">--</div>
                <div class="sub">åˆæœŸè³‡é‡‘: <span id="initial">--</span></div>
            </div>
            <div class="card">
                <h3>æœ‰åŠ¹è¨¼æ‹ é‡‘</h3>
                <div class="value" id="equity">--</div>
                <div class="sub">å«ã¿æç›Š: <span id="unrealized">--</span></div>
            </div>
            <div class="card">
                <h3>ç·æç›Š</h3>
                <div class="value" id="profit">--</div>
                <div class="sub">åˆ©ç›Šç‡: <span id="profitRate">--</span></div>
            </div>
            <div class="card">
                <h3>å¸‚å ´æƒ…å ±</h3>
                <div class="value" id="usdjpy">--</div>
                <div class="sub">TNX: <span id="tnx">--</span>% | 20æ—¥MA: <span id="tnxMa20">--</span>%</div>
            </div>
            <div class="card">
                <h3>ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
                <div class="value" id="trendStatus">--</div>
                <div class="sub">TNX > 20æ—¥MA ã§ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰</div>
            </div>
        </div>

        <!-- è²¡å¸ƒã‚µãƒãƒªãƒ¼ï¼ˆ2ã¤ã®æˆ¦ç•¥ï¼‰ -->
        <h2 class="section-title">ğŸ’° è³‡ç”£ã‚µãƒãƒªãƒ¼</h2>
        <div class="wallet-grid" id="walletGrid">
            <div class="wallet-card swing">
                <h3>ğŸ„ ã‚¹ã‚¤ãƒ³ã‚° (WAIT)</h3>
                <div class="wallet-row">
                    <span class="wallet-label">æ®‹é«˜</span>
                    <span class="wallet-value" id="w_swing_balance">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">ä¿æœ‰æ•°</span>
                    <span class="wallet-value" id="w_swing_units">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">å«ã¿æç›Š</span>
                    <span class="wallet-value" id="w_swing_unrealized">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">åˆ©ç›Šç‡</span>
                    <span class="wallet-value" id="w_swing_rate">--</span>
                </div>
            </div>
            <div class="wallet-card day">
                <h3>âš¡ ãƒ‡ã‚¤ãƒˆãƒ¬ (DAY)</h3>
                <div class="wallet-row">
                    <span class="wallet-label">æ®‹é«˜</span>
                    <span class="wallet-value" id="w_day_balance">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">ä¿æœ‰æ•°</span>
                    <span class="wallet-value" id="w_day_units">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">å«ã¿æç›Š</span>
                    <span class="wallet-value" id="w_day_unrealized">--</span>
                </div>
                <div class="wallet-row">
                    <span class="wallet-label">åˆ©ç›Šç‡</span>
                    <span class="wallet-value" id="w_day_rate">--</span>
                </div>
            </div>
        </div>

        <h2 class="section-title">ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆ</h2>
        <div class="chart-grid">
            <div class="chart-card">
                <h3>ğŸ’° è³‡ç”£æ¨ç§»ï¼ˆEquity Curveï¼‰</h3>
                <canvas id="equityChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>ğŸ’¹ USD/JPY ä¾¡æ ¼æ¨ç§»</h3>
                <canvas id="usdjpyChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>ğŸ“Š TNXï¼ˆç±³10å¹´å‚µåˆ©å›ã‚Šï¼‰</h3>
                <canvas id="tnxChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>ğŸ“‰ æç›Šæ¨ç§»</h3>
                <canvas id="pnlChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">ğŸ“Š ä¿æœ‰ãƒã‚¸ã‚·ãƒ§ãƒ³</h2>
        <table id="positionsTable">
            <thead>
                <tr>
                    <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼</th>
                    <th>æ–¹å‘</th>
                    <th>æ•°é‡</th>
                    <th>å–å¾—ä¾¡æ ¼</th>
                    <th>ç¾åœ¨ä¾¡æ ¼</th>
                    <th>æç›Š</th>
                    <th>ã‚¹ãƒ¯ãƒƒãƒ—</th>
                </tr>
            </thead>
            <tbody id="positions"></tbody>
        </table>

        <h2 class="section-title">ğŸ“ˆ å–å¼•æˆç¸¾</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="label">ç·å–å¼•æ•°</div>
                <div class="val" id="totalTrades">--</div>
            </div>
            <div class="stat-item">
                <div class="label">å‹ç‡</div>
                <div class="val" id="winRate">--</div>
            </div>
            <div class="stat-item">
                <div class="label">å‹ã¡</div>
                <div class="val positive" id="wins">--</div>
            </div>
            <div class="stat-item">
                <div class="label">è² ã‘</div>
                <div class="val negative" id="losses">--</div>
            </div>
        </div>

        <h2 class="section-title">ğŸ„ æ­£çµ±æ´¾æˆ¦ç•¥ å–å¼•å±¥æ­´</h2>
        <table>
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th>
                    <th>æ–¹å‘</th>
                    <th>å–å¾—</th>
                    <th>æ±ºæ¸ˆ</th>
                    <th>æ•°é‡</th>
                    <th>æç›Š</th>
                </tr>
            </thead>
            <tbody id="historyWait"></tbody>
        </table>

        <h2 class="section-title" style="margin-top: 30px;">âš¡ ãƒ‡ã‚¤ãƒˆãƒ¬æˆ¦ç•¥ å–å¼•å±¥æ­´</h2>
        <table>
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th>
                    <th>æ–¹å‘</th>
                    <th>å–å¾—</th>
                    <th>æ±ºæ¸ˆ</th>
                    <th>æ•°é‡</th>
                    <th>æç›Š</th>
                </tr>
            </thead>
            <tbody id="historyDay"></tbody>
        </table>

        <!-- ãƒ‡ã‚¤ãƒˆãƒ¬æˆ¦ç•¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="daytradeSection" style="display:none; margin-top: 40px; padding-top: 30px; border-top: 2px solid #333;">
            <h2 class="section-title">âš¡ ãƒ‡ã‚¤ãƒˆãƒ¬æˆ¦ç•¥ (Day Trade)</h2>

            <div class="grid">
                <div class="card">
                    <h3>æ®‹é«˜</h3>
                    <div class="value" id="dt_balance">--</div>
                    <div class="sub">åˆæœŸ: <span id="dt_initial">--</span></div>
                </div>
                <div class="card">
                    <h3>è©•ä¾¡é¡</h3>
                    <div class="value" id="dt_equity">--</div>
                    <div class="sub">å«ã¿æç›Š: <span id="dt_unrealized">--</span></div>
                </div>
                <div class="card">
                    <h3>ç·æç›Š</h3>
                    <div class="value" id="dt_profit">--</div>
                    <div class="sub">ROI: <span id="dt_roi">--</span></div>
                </div>
                <div class="card">
                    <h3>è¨­å®š</h3>
                    <div class="value" id="dt_lot">--</div>
                    <div class="sub">TP:<span id="dt_tp">--</span> / SL:<span id="dt_sl">--</span></div>
                </div>
            </div>

            <h3 style="margin-top: 20px;">ğŸ“Š å–å¼•çµ±è¨ˆ</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="label">ç·å–å¼•æ•°</div>
                    <div class="val" id="dt_trades">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">å‹ç‡</div>
                    <div class="val" id="dt_winrate">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">åˆ©ç¢º(TP)</div>
                    <div class="val positive" id="dt_tp_count">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">æåˆ‡(SL)</div>
                    <div class="val negative" id="dt_sl_count">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">å¼·åˆ¶æ±ºæ¸ˆ</div>
                    <div class="val" id="dt_forced">--</div>
                </div>
            </div>

            <h3 style="margin-top: 20px;">ğŸ“ ç¾åœ¨ã®ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
            <div id="dt_position" style="padding: 15px; background: #1a1a2e; border-radius: 8px;">
                <span style="color: #666;">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</span>
            </div>
        </div>

        <div class="last-update">æœ€çµ‚æ›´æ–°: <span id="lastUpdate">--</span></div>
    </div>

    <script>
        // Chart instances
        let equityChart, usdjpyChart, tnxChart, pnlChart;

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#888', maxTicksLimit: 6 }
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#888' }
                }
            }
        };

        function initCharts() {
            const ctx1 = document.getElementById('equityChart').getContext('2d');
            equityChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.3 }] },
                options: chartOptions
            });

            const ctx2 = document.getElementById('usdjpyChart').getContext('2d');
            usdjpyChart = new Chart(ctx2, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.1)', fill: true, tension: 0.3 }] },
                options: chartOptions
            });

            const ctx3 = document.getElementById('tnxChart').getContext('2d');
            tnxChart = new Chart(ctx3, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#ffa502', backgroundColor: 'rgba(255,165,2,0.1)', fill: true, tension: 0.3 }] },
                options: chartOptions
            });

            const ctx4 = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx4, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: chartOptions
            });
        }

        function formatCurrency(val) {
            if (val === null || val === undefined) return '--';
            return 'Â¥' + Math.round(val).toLocaleString();
        }

        function formatPnl(val) {
            if (val === null || val === undefined) return '--';
            const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
            const prefix = val > 0 ? '+' : '';
            return `<span class="${cls}">${prefix}Â¥${Math.round(val).toLocaleString()}</span>`;
        }

        function formatDate(isoStr) {
            if (!isoStr) return '--';
            const d = new Date(isoStr);
            return d.toLocaleString('ja-JP', {
                month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatShortDate(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            return d.toLocaleString('ja-JP', { month: '2-digit', day: '2-digit', hour: '2-digit' });
        }

        async function loadData() {
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const status = await fetch('/api/status').then(r => r.json());

                document.getElementById('balance').textContent = formatCurrency(status.balance);
                document.getElementById('initial').textContent = formatCurrency(status.initial_capital);
                document.getElementById('equity').textContent = formatCurrency(status.equity);
                document.getElementById('unrealized').innerHTML = formatPnl(status.unrealized_pnl);
                document.getElementById('profit').innerHTML = formatPnl(status.total_profit);
                document.getElementById('profitRate').textContent =
                    (status.profit_rate >= 0 ? '+' : '') + status.profit_rate.toFixed(2) + '%';
                document.getElementById('profitRate').className =
                    status.profit_rate > 0 ? 'positive' : status.profit_rate < 0 ? 'negative' : '';

                document.getElementById('usdjpy').textContent =
                    status.usdjpy_value ? status.usdjpy_value.toFixed(2) + ' å††' : '--';
                document.getElementById('tnx').textContent =
                    status.tnx_value ? status.tnx_value.toFixed(2) : '--';
                document.getElementById('tnxMa20').textContent =
                    status.tnx_ma20 ? status.tnx_ma20.toFixed(2) : '--';

                // ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤º
                const trendEl = document.getElementById('trendStatus');
                if (status.trend_status === 'UP') {
                    trendEl.innerHTML = 'ğŸ“ˆ ä¸Šæ˜‡';
                    trendEl.className = 'value positive';
                } else if (status.trend_status === 'DOWN') {
                    trendEl.innerHTML = 'ğŸ“‰ ä¸‹é™';
                    trendEl.className = 'value negative';
                } else {
                    trendEl.textContent = '--';
                    trendEl.className = 'value';
                }

                document.getElementById('lastUpdate').textContent = formatDate(status.last_update);

                // ãƒã‚¸ã‚·ãƒ§ãƒ³
                const posHtml = status.positions.length ? status.positions.map(p => `
                    <tr>
                        <td>${formatDate(p.entry_time)}</td>
                        <td><span class="badge ${p.direction.toLowerCase()}">${p.direction}</span></td>
                        <td>${p.units.toLocaleString()}</td>
                        <td>${p.entry_price.toFixed(2)}</td>
                        <td>${p.current_price ? p.current_price.toFixed(2) : '--'}</td>
                        <td>${formatPnl(p.unrealized_pnl)}</td>
                        <td>${formatPnl(p.swap_total)}</td>
                    </tr>
                `).join('') : '<tr><td colspan="7" style="text-align:center;color:#666">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</td></tr>';
                document.getElementById('positions').innerHTML = posHtml;

                // å±¥æ­´ - å„æˆ¦ç•¥åˆ¥ã«è¡¨ç¤º
                const hist = await fetch('/api/history').then(r => r.json());
                const combined = await fetch('/api/history/combined').then(r => r.json());

                document.getElementById('totalTrades').textContent = hist.stats.total_trades;
                document.getElementById('winRate').textContent = hist.stats.win_rate.toFixed(1) + '%';
                document.getElementById('wins').textContent = hist.stats.wins;
                document.getElementById('losses').textContent = hist.stats.losses;

                // æ­£çµ±æ´¾æˆ¦ç•¥ (WAIT)
                const waitHistory = combined.history.filter(h => h.strategy === 'WAIT');
                const waitHtml = waitHistory.length ? waitHistory.map(h => {
                    const dirLabel = h.direction === 'BUY' ? 'ğŸ“ˆ ãƒ­ãƒ³ã‚°' : 'ğŸ“‰ ã‚·ãƒ§ãƒ¼ãƒˆ';
                    return `
                    <tr>
                        <td>${formatDate(h.exit_time)}</td>
                        <td><span class="badge ${h.direction.toLowerCase()}">${dirLabel}</span></td>
                        <td>${h.entry_price.toFixed(2)}</td>
                        <td>${h.exit_price.toFixed(2)}</td>
                        <td>${h.units.toLocaleString()}</td>
                        <td>${formatPnl(h.pnl)}</td>
                    </tr>
                `}).join('') : '<tr><td colspan="6" style="text-align:center;color:#666">å–å¼•å±¥æ­´ãªã—</td></tr>';
                document.getElementById('historyWait').innerHTML = waitHtml;

                // ãƒ‡ã‚¤ãƒˆãƒ¬æˆ¦ç•¥ (DAY)
                const dayHistory = combined.history.filter(h => h.strategy === 'DAY');
                const dayHtml = dayHistory.length ? dayHistory.map(h => {
                    const dirLabel = h.direction === 'BUY' ? 'ğŸ“ˆ ãƒ­ãƒ³ã‚°' : 'ğŸ“‰ ã‚·ãƒ§ãƒ¼ãƒˆ';
                    return `
                    <tr>
                        <td>${formatDate(h.exit_time)}</td>
                        <td><span class="badge ${h.direction.toLowerCase()}">${dirLabel}</span></td>
                        <td>${h.entry_price.toFixed(2)}</td>
                        <td>${h.exit_price.toFixed(2)}</td>
                        <td>${h.units.toLocaleString()}</td>
                        <td>${formatPnl(h.pnl)}</td>
                    </tr>
                `}).join('') : '<tr><td colspan="6" style="text-align:center;color:#666">å–å¼•å±¥æ­´ãªã—</td></tr>';
                document.getElementById('historyDay').innerHTML = dayHtml;

                // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
                const equity = await fetch('/api/equity').then(r => r.json());
                updateCharts(equity.equity_history, hist.history);

            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function updateCharts(equityData, tradeHistory) {
            if (!equityData || equityData.length === 0) return;

            const labels = equityData.map(d => formatShortDate(d.timestamp));

            // Equity Chart
            equityChart.data.labels = labels;
            equityChart.data.datasets[0].data = equityData.map(d => d.equity);
            equityChart.update();

            // USD/JPY Chart
            usdjpyChart.data.labels = labels;
            usdjpyChart.data.datasets[0].data = equityData.map(d => d.usdjpy_value);
            usdjpyChart.update();

            // TNX Chart
            tnxChart.data.labels = labels;
            tnxChart.data.datasets[0].data = equityData.map(d => d.tnx_value);
            tnxChart.update();

            // P&L Chart (from trade history)
            if (tradeHistory && tradeHistory.length > 0) {
                const pnlLabels = tradeHistory.slice(0, 20).reverse().map(t => formatShortDate(t.exit_time));
                const pnlData = tradeHistory.slice(0, 20).reverse().map(t => t.net_pnl);
                const pnlColors = pnlData.map(v => v >= 0 ? 'rgba(0,255,136,0.7)' : 'rgba(255,71,87,0.7)');

                pnlChart.data.labels = pnlLabels;
                pnlChart.data.datasets[0].data = pnlData;
                pnlChart.data.datasets[0].backgroundColor = pnlColors;
                pnlChart.update();
            }
        }

        // ãƒ‡ã‚¤ãƒˆãƒ¬æˆ¦ç•¥ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function loadDaytradeData() {
            try {
                const dt = await fetch('/api/daytrade/status').then(r => r.json());

                if (!dt.exists) {
                    document.getElementById('daytradeSection').style.display = 'none';
                    return;
                }

                document.getElementById('daytradeSection').style.display = 'block';

                document.getElementById('dt_balance').textContent = formatCurrency(dt.balance);
                document.getElementById('dt_initial').textContent = formatCurrency(dt.initial_capital);
                document.getElementById('dt_equity').textContent = formatCurrency(dt.equity);
                document.getElementById('dt_unrealized').innerHTML = formatPnl(dt.unrealized_pnl);
                document.getElementById('dt_profit').innerHTML = formatPnl(dt.total_profit);
                document.getElementById('dt_roi').textContent = (dt.profit_rate >= 0 ? '+' : '') + dt.profit_rate.toFixed(2) + '%';
                document.getElementById('dt_roi').className = dt.profit_rate > 0 ? 'positive' : dt.profit_rate < 0 ? 'negative' : '';

                document.getElementById('dt_lot').textContent = (dt.settings.lot_ratio * 100).toFixed(0) + '%';
                document.getElementById('dt_tp').textContent = '+' + dt.settings.take_profit + 'å††';
                document.getElementById('dt_sl').textContent = '-' + dt.settings.stop_loss + 'å††';

                document.getElementById('dt_trades').textContent = dt.stats.total_trades;
                document.getElementById('dt_winrate').textContent = dt.stats.win_rate.toFixed(1) + '%';
                document.getElementById('dt_tp_count').textContent = dt.stats.tp_count;
                document.getElementById('dt_sl_count').textContent = dt.stats.sl_count;
                document.getElementById('dt_forced').textContent = dt.stats.forced_count;

                // ãƒã‚¸ã‚·ãƒ§ãƒ³è¡¨ç¤º
                const posEl = document.getElementById('dt_position');
                if (dt.position) {
                    const p = dt.position;
                    posEl.innerHTML = `
                        <span class="badge buy">BUY</span>
                        <strong>${p.units.toLocaleString()}</strong> é€šè²¨ @ ${p.entry_price.toFixed(2)}
                        â†’ å«ã¿æç›Š: ${formatPnl(p.unrealized_pnl)}
                    `;
                } else {
                    posEl.innerHTML = '<span style="color: #666;">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</span>';
                }

            } catch (e) {
                console.error('Error loading daytrade data:', e);
            }
        }

        // è²¡å¸ƒã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿
        async function loadWallets() {
            try {
                const data = await fetch('/api/wallets').then(r => r.json());

                data.wallets.forEach(w => {
                    const prefix = w.strategy === 'WAIT' ? 'w_swing' : 'w_day';
                    document.getElementById(`${prefix}_balance`).textContent = formatCurrency(w.balance);

                    if (w.total_units > 0) {
                        document.getElementById(`${prefix}_units`).innerHTML =
                            `${w.total_units.toLocaleString()} <span class="badge ${w.direction?.toLowerCase() || ''}">${w.direction || ''}</span>`;
                    } else {
                        document.getElementById(`${prefix}_units`).textContent = 'ãªã—';
                    }

                    document.getElementById(`${prefix}_unrealized`).innerHTML = formatPnl(w.unrealized_pnl);

                    const rateEl = document.getElementById(`${prefix}_rate`);
                    rateEl.textContent = (w.profit_rate >= 0 ? '+' : '') + w.profit_rate.toFixed(2) + '%';
                    rateEl.className = 'wallet-value ' + (w.profit_rate > 0 ? 'positive' : w.profit_rate < 0 ? 'negative' : '');
                });
            } catch (e) {
                console.error('Error loading wallets:', e);
            }
        }

        // Initialize
        initCharts();
        loadData();
        loadWallets();
        loadDaytradeData();
        setInterval(loadData, 60000);
        setInterval(loadWallets, 60000);
        setInterval(loadDaytradeData, 60000);
    </script>
</body>
</html>
